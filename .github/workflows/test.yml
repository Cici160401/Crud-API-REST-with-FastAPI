name: test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ALGORITHM: ${{ secrets.ALGORITHM }}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      TEST_TOKEN: ${{ secrets.TEST_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # Hemos eliminado la línea problemática "python -m site --sys-paths"
      - name: Display Python environment info (debug)
        run: |
          echo "--- Python Version ---"
          python --version
          echo "--- Which Python ---"
          which python
          echo "--- Python sys.path ---"
          python -c "import sys; print('\n'.join(sys.path))"
          echo "--- Python User Site ---"
          python -m site --user-site

      - name: Display requirements.txt content on runner
        run: |
          echo "--- Content of requirements.txt ---"
          cat requirements.txt # ESTO ES LO QUE NECESITAMOS VER
          echo "-----------------------------------"

      - name: Install dependencies (verbose)
        run: |
          echo "--- Upgrading pip ---"
          python -m pip install --upgrade pip
          echo "--- Installing from requirements.txt ---"
          pip install -r requirements.txt -v # -v para salida detallada
          echo "--- Explicitly installing pymysql (as a fallback, check if it's needed) ---"
          pip install pymysql -v # -v para salida detallada

      - name: Verify installed packages (detailed debug)
        run: |
          echo "--- Listing all installed packages ---"
          pip list
          echo "--- Checking pymysql details ---"
          pip show pymysql || echo "❌ pymysql NOT FOUND after install"

      - name: Run tests
        run: |
          export PYTHONPATH=.
          pytest tests/